# 项目维护指南

本文档面向新加入的开发者与 AI IDE 会话，帮助快速理解项目结构、技术栈与运行流程，并提供开发/测试规范。

---

## 1. 项目概述
- 核心功能：基于 pytest 与 olymat 工具集的测试脚手架，演示如何加载统一配置、初始化 SSH 测试环境与提供会话级上下文 ctx/cfg，用于快速编写与运行集成/功能测试。
- 主要目标用户：编写自动化测试、环境验证与简单示例功能的 Python 开发者或测试工程师。

---

## 2. 技术栈分析
- 编程语言：Python（建议 3.10+）
- 运行环境：已预置 venv；所有命令需在项目根目录 + 已激活 venv 中执行
- 核心框架/库：
  - pytest（测试框架，pytest.ini 已配置日志与选项）
  - olymat（从 gitee 安装的内部/第三方工具集）
  - olymat_comm（从 gitee 安装的通用组件）
- 数据库：未使用
- 其他关键技术：
  - SSH 测试基建：通过 `olymat.utils.ssh_helper.init_ssh_fixtures` 初始化与分组
  - 配置中心：通过 `olymat.plugin.get_conf()` 读取（支持默认配置与本地 conf.yaml 覆盖）

---

## 3. 环境设置与启动指南

### 3.1 依赖安装

重要：本项目已预置 venv。所有命令均在“已激活 venv 且位于项目根目录”执行。
- Windows PowerShell（在项目根目录）：
```
.\venv\Scripts\Activate.ps1
```

在项目根目录（已激活 venv）安装/更新依赖：
```
pip install -r requirements.txt
```


### 3.2 项目启动
本项目为测试脚手架，无独立运行入口。以 pytest 驱动执行用例。所有工具或测试的执行均以 pytest 用例形式存在。
前提：必须先在项目根目录激活 venv，然后在项目根目录执行命令。

- 运行测试（项目根目录，已激活 venv）：
```
pytest
```
或使用 pytest.ini 中的推荐选项（已包含 -s/-x 与日志级别）：
```
pytest -s -x --log-cli-level=info
```

### 3.3 运行测试
所有 pytest 命令均需在“项目根目录 + 已激活 venv”环境下执行。
- 单文件/单目录选择性执行：
```
pytest test_hello
pytest test_hello/test_hello/hello_test.py
```
- 过滤测试函数：
```
pytest -k "hello_cfg or hello_ctx"
```
遵循 pytest 最佳实践即可，本指南不展开更多细节。

---

## 4. 项目结构分析

### 4.1 目录结构（核心）
- 根目录运行原则：所有命令均在项目根目录执行；pytest 前需激活 venv
- `conf.yaml`：项目级配置（work_data_dir、插件进出端等）
- `conftest.py`：根级 pytest 配置钩子（加载/初始化 olymat 配置）
- `pytest.ini`：pytest 全局配置（minversion、日志、addopts）
- `requirements.txt`：依赖清单（从 gitee 安装 olymat 与 olymat_comm）
- `docs/`：文档目录（本指南位于 `docs/项目维护指南.md`）
- 测试工具集（根目录下以 test_ 开头的文件夹即为工具集；可有多个；`test_hello` 为样例）
  - `test_hello/`
    - `__init__.py`
    - `config.py`：封装 get_conf 为全局 Config（DotDict），并尽早初始化默认配置
    - `conftest.py`：定义会话级 `cfg` 与 `ctx` fixture，初始化 SSH 测试夹具
    - `confs/default.yaml`：工具集默认配置；在 `test_` 方法中通过 `cfg` fixture 访问
    - `test_hello/hello_test.py`：样例用例，演示 cfg 读取与 ctx 跨用例持久化

  - 你可以新增同结构的工具集目录，例如 `test_xxx/`、`test_api/` 等



### 4.2 工具集结构约定（模板）
建议每个工具集目录均与 `test_hello` 同构，典型模板如下：
```
test_xxx/
  __init__.py
  config.py
  conftest.py
  confs/
    default.yaml
  test_xxx/
    sample_test.py
```

### 4.3 关键文件解读
- 根级 `conftest.py`
  - 通过 `update_olymat_conf` 与 `init_olymat_conf` 将 `get_conf()` 注入 pytest 配置，支持保护模式、安全模式等。
- 工具集样例 `test_hello/`（其他工具集应与其结构一致）
  - `config.py`：`get_g_conf()`（@func_run_once）返回 `Config(DotDict(get_conf()))`，导入即初始化，确保默认配置可用。
  - `conftest.py`：
    - `cfg` fixture（session）：返回全局配置
    - `ctx` fixture（session）：使用 `make_default_ctx(__file__)` 构建跨用例共享上下文
  - `test_hello/test_hello/hello_test.py`：
    - `test_hello_cfg`：演示从配置中读取 `cfg.test_hello.hello`
    - `test_hello_ctx` / `test_hello_ctx2`：验证 `ctx` 属性跨用例保持


---

## 5. 核心模块与业务逻辑

### 5.1 主要模块
- 配置管理：`olymat.plugin.get_conf` + `DotDict`，统一读取默认/本地配置
- 测试基建：pytest + 根级 conftest 钩子初始化
- SSH 支撑：`init_ssh_fixtures` 基于 `env.servers` 分组构建 SSH 相关夹具
- 上下文管理：`make_default_ctx` 提供会话级 `ctx`，简化跨用例状态共享
- Fixture 约定：`cfg` 提供工具集 `confs/default.yaml` 合并后的配置；`ctx` 为会话级上下文，可在不同 `test_` 方法间共享

### 5.2 典型数据流（测试执行）
1. pytest 启动，根级 conftest 通过 `update_olymat_conf` 注入配置并 `init_olymat_conf`
2. 导入 `test_hello/config.py` 时调用 `get_g_conf()`，确保默认/本地配置就位
3. `test_hello/conftest.py` 初始化 SSH 夹具与会话级 `cfg`、`ctx`
4. 测试用例运行，读取 `cfg.*` 配置，或在 `ctx` 上读写跨用例状态
5. 会话结束时，根级 hook 可在非安全/调试模式下执行收尾逻辑


---

## 6. 数据模型与持久化
- 未使用 ORM 或数据库模型。

---

## 7. 开发规范与工作流

### 7.1 编码风格
- Python 常规风格（建议遵循 PEP 8）
- 测试命名：pytest 规范（文件/函数以 `test_*.py` / `test_*` 命名）
- 避免使用异常吞噬来掩盖问题，应定位根因后修复



---


## 附注
以下主题在当前项目中未作强约束，AI IDE 无需特别关注：环境变量、工具 UI 配置（olymat_ui）、仓库根目录 conf.yaml 细节、新工具集流程、关键类/函数细表。

