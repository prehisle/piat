# æ™ºèƒ½è‡ªåŠ¨åŒ–æµ‹è¯•è„šæ‰‹æ¶ - é¡¹ç›®ç»´æŠ¤æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

åŸºäº pytest + Playwright + olymat æ¡†æ¶çš„æ™ºèƒ½æµè§ˆå™¨è‡ªåŠ¨åŒ–æµ‹è¯•è„šæ‰‹æ¶ï¼Œæ ¸å¿ƒè§£å†³æµè§ˆå™¨ç™»å½•çŠ¶æ€ç®¡ç†é—®é¢˜ï¼Œè®©æµ‹è¯•å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å®ç°ã€‚

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

### æ ¸å¿ƒç»„ä»¶
- **olymat æ¡†æ¶**ï¼šåŸºç¡€æµ‹è¯•æ¡†æ¶ï¼Œæä¾›é…ç½®ç®¡ç†å’ŒåŸºç¡€ fixtures
- **Playwright**ï¼šæµè§ˆå™¨è‡ªåŠ¨åŒ–å¼•æ“
- **SimpleBrowserAuth**ï¼šæ ¸å¿ƒç™»å½•çŠ¶æ€ç®¡ç†ç±»

### ç›®å½•ç»“æ„
```
test_core/
â”œâ”€â”€ confs/
â”‚   â””â”€â”€ default.yaml          # æ ¸å¿ƒé…ç½®æ–‡ä»¶
â”œâ”€â”€ browser_helper.py         # æµè§ˆå™¨ç™»å½•çŠ¶æ€ç®¡ç†
â”œâ”€â”€ conftest.py              # pytest fixtures é…ç½®
â”œâ”€â”€ test_browser/            # æµè§ˆå™¨æµ‹è¯•ç”¨ä¾‹
â”‚   â””â”€â”€ test_baidu.py        # ç¤ºä¾‹æµ‹è¯•
â””â”€â”€ auth/                    # ç™»å½•çŠ¶æ€å­˜å‚¨ç›®å½• (git ignored)
    â””â”€â”€ *.json              # ç”¨æˆ·ç™»å½•çŠ¶æ€æ–‡ä»¶
```

## âš™ï¸ é…ç½®ç³»ç»Ÿ

### ä¸»é…ç½®æ–‡ä»¶ï¼š`test_core/confs/default.yaml`
```yaml
browser:
  sites:
    baidu:
      login_url: "https://www.baidu.com/"
      success_selector: "#s-top-username"
```

### é…ç½®è¯´æ˜
- **sites**: ç›®æ ‡æµ‹è¯•ç½‘ç«™é…ç½®
  - `login_url`: ç™»å½•é¡µé¢URL
  - `success_selector`: ç™»å½•æˆåŠŸéªŒè¯çš„CSSé€‰æ‹©å™¨

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. ç™»å½•çŠ¶æ€ç®¡ç† (`SimpleBrowserAuth`)

**çŠ¶æ€æŒä¹…åŒ–**ï¼š
- ä½¿ç”¨ Playwright çš„ `storage_state()` ä¿å­˜å®Œæ•´æµè§ˆå™¨çŠ¶æ€
- åŒ…å« cookies, localStorage, sessionStorage ç­‰
- æ–‡ä»¶æ ¼å¼ï¼š`auth/{site}_{user}.json`

### 2. æµ‹è¯•ç¼–å†™æ¥å£

**Fixture ä½¿ç”¨**ï¼š
```python
# åœ¨ conftest.py ä¸­ä¸ºæ¯ä¸ªç”¨æˆ·å®šä¹‰ä¸€ä¸ª session çº§åˆ«çš„ fixture
@pytest.fixture(scope="session")
def page_user_a(auth):
    page, context = auth.get_logged_in_page('baidu', 'user_a')
    yield page
    context.close()

# åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­ç›´æ¥ä½¿ç”¨ fixture
def test_baidu_homepage_user_a(page_user_a):
    """æµ‹è¯•ç™¾åº¦é¦–é¡µç™»å½•çŠ¶æ€ - user_a"""
    page = page_user_a
    page.goto('https://www.baidu.com')
    # ...
```
è¿™ç§æ–¹å¼ç®€åŒ–äº†æµ‹è¯•ç”¨ä¾‹çš„ç¼–å†™ï¼Œæ— éœ€å†ä½¿ç”¨ `parametrize` æ¥é—´æ¥ä¼ é€’å‚æ•°ã€‚

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. VSCode ä¸­è¿è¡Œæµ‹è¯•
- ç‚¹å‡»æµ‹è¯•æ–‡ä»¶ä¸­çš„ â–¶ï¸ æŒ‰é’®
- ä½¿ç”¨æµ‹è¯•èµ„æºç®¡ç†å™¨
- **è‡ªåŠ¨è¡Œä¸º**ï¼šæ— å¤´æ¨¡å¼ï¼Œæ¨¡æ‹Ÿç™»å½•ï¼Œå¿«é€Ÿæ‰§è¡Œ

### 2. å‘½ä»¤è¡Œè¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œå•ä¸ªæµ‹è¯•
pytest test_core/test_browser/test_baidu.py::test_baidu_homepage_user_a -v -s

# è¿è¡Œæ‰€æœ‰æµè§ˆå™¨æµ‹è¯•
pytest test_core/test_browser/ -v -s
```
**è‡ªåŠ¨è¡Œä¸º**ï¼šæ‰“å¼€æµè§ˆå™¨ï¼Œç­‰å¾…æ‰‹åŠ¨ç™»å½•ï¼Œä¿å­˜çŠ¶æ€

### 3. è°ƒè¯•æ¨¡å¼
- è®¾ç½®æ–­ç‚¹åä½¿ç”¨ F5 è°ƒè¯•
- **è‡ªåŠ¨è¡Œä¸º**ï¼šæœ‰å¤´æ¨¡å¼ï¼Œæ”¯æŒäº¤äº’å¼ç™»å½•

## ğŸ” ç¯å¢ƒè¡Œä¸ºå¯¹æ¯”

| ç¯å¢ƒ | æµè§ˆå™¨æ¨¡å¼ | ç™»å½•æ–¹å¼ | è¶…æ—¶æ—¶é—´ | é€‚ç”¨åœºæ™¯ |
|------|------------|----------|----------|----------|
| å‘½ä»¤è¡Œ | æœ‰å¤´æ¨¡å¼ | æ‰‹åŠ¨ç™»å½• | 5åˆ†é’Ÿ | çœŸå®ç¯å¢ƒæµ‹è¯• |
| è°ƒè¯•æ¨¡å¼ | æœ‰å¤´æ¨¡å¼ | æ‰‹åŠ¨ç™»å½• | 5åˆ†é’Ÿ | é—®é¢˜è°ƒè¯• |

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°ç½‘ç«™æ”¯æŒ
1. åœ¨ `default.yaml` ä¸­æ·»åŠ ç½‘ç«™é…ç½®ï¼š
```yaml
browser:
  sites:
    new_site:
      login_url: "https://example.com/login"
      success_selector: ".user-menu"
```

2. åˆ›å»ºæµ‹è¯•ç”¨ä¾‹ï¼š
```python
# åœ¨ conftest.py ä¸­ä¸ºæ–°ç½‘ç«™å’Œç”¨æˆ·åˆ›å»º fixture
@pytest.fixture(scope="session")
def page_new_site_user_a(auth):
    page, context = auth.get_logged_in_page('new_site', 'user_a')
    yield page
    context.close()

# åœ¨æµ‹è¯•æ–‡ä»¶ä¸­ä½¿ç”¨
def test_new_site_feature(page_new_site_user_a):
    # æµ‹è¯•é€»è¾‘
```



## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. é€‰æ‹©å™¨æ‰¾ä¸åˆ°å…ƒç´ **
- æ£€æŸ¥ `success_selector` é…ç½®
- ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·éªŒè¯é€‰æ‹©å™¨
- è€ƒè™‘é¡µé¢åŠ è½½æ—¶é—´ï¼Œè°ƒæ•´è¶…æ—¶è®¾ç½®

### è°ƒè¯•æŠ€å·§

**æŸ¥çœ‹æµè§ˆå™¨çŠ¶æ€**ï¼š
```python
# åœ¨æµ‹è¯•ä¸­æ·»åŠ è°ƒè¯•ä»£ç 
page.screenshot(path="debug.png")
print(page.content())
```

**æ£€æŸ¥ç™»å½•çŠ¶æ€æ–‡ä»¶**ï¼š
```bash
# æŸ¥çœ‹ä¿å­˜çš„çŠ¶æ€
cat auth/baidu_user_a.json
```

## ğŸ”„ ç»´æŠ¤ä»»åŠ¡

### å®šæœŸç»´æŠ¤
1. **æ¸…ç†è¿‡æœŸçŠ¶æ€æ–‡ä»¶**ï¼šå®šæœŸåˆ é™¤ `auth/` ç›®å½•ä¸‹çš„æ—§æ–‡ä»¶
2. **æ›´æ–°é€‰æ‹©å™¨**ï¼šç½‘ç«™æ”¹ç‰ˆæ—¶æ›´æ–° `success_selector`
3. **ä¾èµ–æ›´æ–°**ï¼šå®šæœŸæ›´æ–° Playwright å’Œç›¸å…³ä¾èµ–


## ğŸ¯ æœ€ä½³å®è·µ

1. **æµ‹è¯•éš”ç¦»**ï¼šæ¯ä¸ªæµ‹è¯•ç‹¬ç«‹çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡
2. **çŠ¶æ€ç®¡ç†**ï¼šåˆç†ä½¿ç”¨ç™»å½•çŠ¶æ€ç¼“å­˜
3. **é”™è¯¯å¤„ç†**ï¼šä¼˜é›…å¤„ç†ç½‘ç»œå¼‚å¸¸å’Œè¶…æ—¶
4. **ç¯å¢ƒé€‚é…**ï¼šæ ¹æ®è¿è¡Œç¯å¢ƒè‡ªåŠ¨è°ƒæ•´è¡Œä¸º
5. **æ–‡æ¡£ç»´æŠ¤**ï¼šåŠæ—¶æ›´æ–°é…ç½®å’Œä½¿ç”¨è¯´æ˜

