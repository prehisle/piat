# 智能自动化测试脚手架 - 项目维护指南

## 📋 项目概述

基于 pytest + Playwright + olymat 框架的智能浏览器自动化测试脚手架，核心解决浏览器登录状态管理问题，让测试开发者专注于业务逻辑实现。

## 🏗️ 项目架构

### 核心组件
- **olymat 框架**：基础测试框架，提供配置管理和基础 fixtures
- **Playwright**：浏览器自动化引擎
- **SimpleBrowserAuth**：核心登录状态管理类

### 目录结构
```
test_core/
├── confs/
│   └── default.yaml          # 核心配置文件
├── browser_helper.py         # 浏览器登录状态管理
├── conftest.py              # pytest fixtures 配置
├── test_browser/            # 浏览器测试用例
│   └── test_baidu.py        # 示例测试
└── auth/                    # 登录状态存储目录 (git ignored)
    └── *.json              # 用户登录状态文件
```

## ⚙️ 配置系统

### 主配置文件：`test_core/confs/default.yaml`
```yaml
browser:
  sites:
    baidu:
      login_url: "https://www.baidu.com/"
      success_selector: "#s-top-username"
```

### 配置说明
- **sites**: 目标测试网站配置
  - `login_url`: 登录页面URL
  - `success_selector`: 登录成功验证的CSS选择器

## 🔧 核心功能

### 1. 登录状态管理 (`SimpleBrowserAuth`)

**状态持久化**：
- 使用 Playwright 的 `storage_state()` 保存完整浏览器状态
- 包含 cookies, localStorage, sessionStorage 等
- 文件格式：`auth/{site}_{user}.json`

### 2. 测试编写接口

**Fixture 使用**：
```python
# 在 conftest.py 中为每个用户定义一个 session 级别的 fixture
@pytest.fixture(scope="session")
def page_user_a(auth):
    page, context = auth.get_logged_in_page('baidu', 'user_a')
    yield page
    context.close()

# 在测试用例中直接使用 fixture
def test_baidu_homepage_user_a(page_user_a):
    """测试百度首页登录状态 - user_a"""
    page = page_user_a
    page.goto('https://www.baidu.com')
    # ...
```
这种方式简化了测试用例的编写，无需再使用 `parametrize` 来间接传递参数。

## 🚀 使用方法

### 1. VSCode 中运行测试
- 点击测试文件中的 ▶️ 按钮
- 使用测试资源管理器
- **自动行为**：无头模式，模拟登录，快速执行

### 2. 命令行运行测试
```bash
# 运行单个测试
pytest test_core/test_browser/test_baidu.py::test_baidu_homepage_user_a -v -s

# 运行所有浏览器测试
pytest test_core/test_browser/ -v -s
```
**自动行为**：打开浏览器，等待手动登录，保存状态

### 3. 调试模式
- 设置断点后使用 F5 调试
- **自动行为**：有头模式，支持交互式登录

## 🔍 环境行为对比

| 环境 | 浏览器模式 | 登录方式 | 超时时间 | 适用场景 |
|------|------------|----------|----------|----------|
| 命令行 | 有头模式 | 手动登录 | 5分钟 | 真实环境测试 |
| 调试模式 | 有头模式 | 手动登录 | 5分钟 | 问题调试 |

## 📝 开发指南

### 添加新网站支持
1. 在 `default.yaml` 中添加网站配置：
```yaml
browser:
  sites:
    new_site:
      login_url: "https://example.com/login"
      success_selector: ".user-menu"
```

2. 创建测试用例：
```python
# 在 conftest.py 中为新网站和用户创建 fixture
@pytest.fixture(scope="session")
def page_new_site_user_a(auth):
    page, context = auth.get_logged_in_page('new_site', 'user_a')
    yield page
    context.close()

# 在测试文件中使用
def test_new_site_feature(page_new_site_user_a):
    # 测试逻辑
```



## 🛠️ 故障排除

### 常见问题

**1. 选择器找不到元素**
- 检查 `success_selector` 配置
- 使用浏览器开发者工具验证选择器
- 考虑页面加载时间，调整超时设置

### 调试技巧

**查看浏览器状态**：
```python
# 在测试中添加调试代码
page.screenshot(path="debug.png")
print(page.content())
```

**检查登录状态文件**：
```bash
# 查看保存的状态
cat auth/baidu_user_a.json
```

## 🔄 维护任务

### 定期维护
1. **清理过期状态文件**：定期删除 `auth/` 目录下的旧文件
2. **更新选择器**：网站改版时更新 `success_selector`
3. **依赖更新**：定期更新 Playwright 和相关依赖


## 🎯 最佳实践

1. **测试隔离**：每个测试独立的浏览器上下文
2. **状态管理**：合理使用登录状态缓存
3. **错误处理**：优雅处理网络异常和超时
4. **环境适配**：根据运行环境自动调整行为
5. **文档维护**：及时更新配置和使用说明

